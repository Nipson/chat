<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en Tiempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .delete-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message.own .message-content {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.own .message-content::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 15px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #3b82f6;
        }

        .message:not(.own) .message-content::after {
            content: '';
            position: absolute;
            left: -8px;
            top: 15px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .username {
            font-weight: bold;
        }

        .timestamp {
            color: #64748b;
        }

        .message.own .timestamp {
            color: rgba(255,255,255,0.8);
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.4;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .username-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            width: 150px;
            transition: border-color 0.3s;
        }

        .username-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .send-btn {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            left: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .input-container {
                flex-wrap: wrap;
            }

            .username-input {
                width: 100%;
                margin-bottom: 10px;
            }

            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator" id="statusIndicator">Conectado</div>
            <div class="chat-title">Chat en Tiempo Real</div>
            <div class="user-info" id="userInfo">Cargando información del usuario...</div>
            <button class="delete-btn" onclick="deleteMyMessages()">Eliminar mis mensajes</button>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="loading">Cargando mensajes...</div>
        </div>

        <div class="input-container">
            <input type="text" id="usernameInput" class="username-input" placeholder="Tu nombre" maxlength="20">
            <input type="text" id="messageInput" class="message-input" placeholder="Escribe tu mensaje..." maxlength="500">
            <button class="send-btn" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        // Configuración
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwtP3GDfH3nUDWzaGr09qYgm54EQ6XGDfN6gJc9WG19Ai6xYbJlkaJeWMiJU65lCRit/exec'; // Reemplazar con la URL de tu script
        let currentUser = {
            ip: '',
            name: '',
            color: '#3b82f6'
        };
        let lastMessageId = 0;
        let isPolling = false;

        // Colores disponibles para usuarios
        const userColors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16',
            '#f97316', '#6366f1', '#14b8a6', '#eab308'
        ];

        // Inicializar aplicación
        async function init() {
            await getUserInfo();
            await loadMessages();
            startPolling();
            setupEventListeners();
        }

        // Obtener información del usuario basada en IP
        async function getUserInfo() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                currentUser.ip = data.ip;
                
                // Generar color basado en IP
                const ipHash = hashCode(currentUser.ip);
                currentUser.color = userColors[Math.abs(ipHash) % userColors.length];
                
                // Nombre por defecto basado en IP
                const ipParts = currentUser.ip.split('.');
                currentUser.name = `Usuario${ipParts[ipParts.length-1]}`;
                
                document.getElementById('usernameInput').value = currentUser.name;
                document.getElementById('userInfo').textContent = `Tu IP: ${currentUser.ip}`;
            } catch (error) {
                console.error('Error obteniendo IP:', error);
                currentUser.ip = 'unknown_' + Math.random().toString(36).substr(2, 9);
                currentUser.name = 'Usuario' + Math.floor(Math.random() * 1000);
                document.getElementById('usernameInput').value = currentUser.name;
                document.getElementById('userInfo').textContent = 'IP no detectada';
            }
        }

        // Función hash para generar colores consistentes
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('usernameInput').addEventListener('input', function(e) {
                currentUser.name = e.target.value || `Usuario${currentUser.ip.split('.').pop()}`;
            });
        }

        // Enviar mensaje
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            const usernameInput = document.getElementById('usernameInput');
            currentUser.name = usernameInput.value.trim() || currentUser.name;

            try {
                showStatus('Enviando...');
                
                const formData = new FormData();
                formData.append('action', 'send');
                formData.append('userIp', currentUser.ip);
                formData.append('userName', currentUser.name);
                formData.append('userColor', currentUser.color);
                formData.append('message', message);

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                
                if (result === 'success') {
                    messageInput.value = '';
                    showStatus('Enviado', 1000);
                    await loadMessages();
                } else {
                    throw new Error('Error del servidor');
                }
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                showStatus('Error al enviar', 2000);
            }
        }

        // Cargar mensajes
        async function loadMessages() {
            try {
                const formData = new FormData();
                formData.append('action', 'load');
                formData.append('lastId', lastMessageId);

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const messages = await response.json();
                
                if (messages && messages.length > 0) {
                    displayMessages(messages);
                    lastMessageId = Math.max(...messages.map(m => m.id));
                }

                // Remover loading si es la primera carga
                const loading = document.querySelector('.loading');
                if (loading) {
                    loading.remove();
                }
            } catch (error) {
                console.error('Error cargando mensajes:', error);
                const loading = document.querySelector('.loading');
                if (loading) {
                    loading.textContent = 'Error cargando mensajes. Reintentando...';
                }
            }
        }

        // Mostrar mensajes en la interfaz
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.userIp === currentUser.ip ? 'own' : ''}`;
                messageDiv.dataset.messageId = msg.id;

                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.style.backgroundColor = msg.userColor;
                avatar.textContent = msg.userName.charAt(0).toUpperCase();

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';

                const username = document.createElement('span');
                username.className = 'username';
                username.textContent = msg.userName;

                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = new Date(msg.timestamp).toLocaleTimeString();

                infoDiv.appendChild(username);
                infoDiv.appendChild(timestamp);

                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = msg.message;

                contentDiv.appendChild(infoDiv);
                contentDiv.appendChild(textDiv);

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);

                container.appendChild(messageDiv);
            });

            scrollToBottom();
        }

        // Eliminar mensajes propios
        async function deleteMyMessages() {
            if (!confirm('¿Estás seguro de que quieres eliminar todos tus mensajes?')) {
                return;
            }

            try {
                showStatus('Eliminando mensajes...');
                
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('userIp', currentUser.ip);

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                
                if (result === 'success') {
                    // Remover mensajes propios de la interfaz
                    const myMessages = document.querySelectorAll('.message.own');
                    myMessages.forEach(msg => msg.remove());
                    
                    showStatus('Mensajes eliminados', 2000);
                } else {
                    throw new Error('Error del servidor');
                }
            } catch (error) {
                console.error('Error eliminando mensajes:', error);
                showStatus('Error al eliminar', 2000);
            }
        }

        // Polling para nuevos mensajes
        function startPolling() {
            if (isPolling) return;
            isPolling = true;
            
            setInterval(async () => {
                await loadMessages();
            }, 3000); // Verificar cada 3 segundos
        }

        // Mostrar indicador de estado
        function showStatus(message, duration = 3000) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.style.display = 'none';
            }, duration);
        }

        // Scroll automático al final
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Inicializar cuando cargue la página
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>